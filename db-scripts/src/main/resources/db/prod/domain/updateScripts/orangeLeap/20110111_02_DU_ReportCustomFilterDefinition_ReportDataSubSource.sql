START TRANSACTION;

INSERT REPORTCUSTOMFILTERDEFINITION_REPORTDATASUBSOURCE
(reportCustomFilterDefinitions_REPORTCUSTOMFILTERDEFINITION_ID, reportDataSubSource_REPORTSUBSOURCE_ID, REPORTSUBSOURCE_ID, REPORTCUSTOMFILTERDEFINITION_ID)
SELECT REPORTCUSTOMFILTERDEFINITION_ID, REPORTSUBSOURCE_ID, REPORTSUBSOURCE_ID, REPORTCUSTOMFILTERDEFINITION_ID + REPORTSUBSOURCE_ID
FROM REPORTCUSTOMFILTERDEFINITION
JOIN REPORTDATASUBSOURCE ON VIEW_NAME IN ('VW_V2_CONSTITUENTS_EMAILS','VW_V2_CONSTITUENTS_PRIMARYCONTACTINFORMATION')
WHERE SQL_TEXT = 'EXISTS (SELECT * FROM THEGURU_SEGMENTATION_RESULT SEGTABLE WHERE SEGTABLE.REPORT_ID = {0} AND SEGTABLE.ENTITY_ID = [VIEWNAME].CONSTITUENT_CONSTITUENT_ID)'
AND NOT EXISTS (SELECT * FROM REPORTCUSTOMFILTERDEFINITION_REPORTDATASUBSOURCE B
WHERE B.reportCustomFilterDefinitions_REPORTCUSTOMFILTERDEFINITION_ID = REPORTCUSTOMFILTERDEFINITION.REPORTCUSTOMFILTERDEFINITION_ID
AND B.reportDataSubSource_REPORTSUBSOURCE_ID = REPORTDATASUBSOURCE.REPORTSUBSOURCE_ID);

INSERT REPORTSEGMENTATIONTYPE_REPORTDATASUBSOURCE
(reportSegmentationTypes_REPORTSEGMENTATIONTYPE_ID, reportDataSubSource_REPORTSUBSOURCE_ID, REPORTSUBSOURCE_ID, REPORTSEGMENTATIONTYPE_ID)
SELECT REPORTSEGMENTATIONTYPE_ID, REPORTSUBSOURCE_ID, REPORTSUBSOURCE_ID, REPORTSEGMENTATIONTYPE_ID FROM REPORTSEGMENTATIONTYPE
JOIN REPORTDATASUBSOURCE ON VIEW_NAME IN ('VW_V2_CONSTITUENTS_EMAILS','VW_V2_CONSTITUENTS_PRIMARYCONTACTINFORMATION')
WHERE COLUMN_NAME = 'CONSTITUENT_CONSTITUENT_ID'
AND NOT EXISTS (SELECT * FROM REPORTSEGMENTATIONTYPE_REPORTDATASUBSOURCE
WHERE REPORTSEGMENTATIONTYPE_REPORTDATASUBSOURCE.reportSegmentationTypes_REPORTSEGMENTATIONTYPE_ID = REPORTSEGMENTATIONTYPE.REPORTSEGMENTATIONTYPE_ID
AND REPORTSEGMENTATIONTYPE_REPORTDATASUBSOURCE.reportDataSubSource_REPORTSUBSOURCE_ID = REPORTDATASUBSOURCE.REPORTSUBSOURCE_ID);

COMMIT;